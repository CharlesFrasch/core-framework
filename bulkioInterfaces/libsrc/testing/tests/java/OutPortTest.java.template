/*
 * This file is protected by Copyright. Please refer to the COPYRIGHT file
 * distributed with this source distribution.
 *
 * This file is part of REDHAWK bulkioInterfaces.
 *
 * REDHAWK bulkioInterfaces is free software: you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as published by the
 * Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * REDHAWK bulkioInterfaces is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License
 * for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/.
 */
/*
 * WARNING: This file is generated from OutPortTest.java.template.
 *          Do not modify directly.
 */

import org.junit.*;

import bulkio.Out@name@Port;

import stubs.In@name@PortStub;
import helpers.@name@TestHelper;

public class Out@name@PortTest {

    protected Out@name@Port port;
    protected stubs.In@name@PortStub stub;

    protected @name@TestHelper helper = new @name@TestHelper();

    @Before
    public void setUp() throws org.omg.CORBA.UserException
    {
        org.omg.CORBA.ORB orb = org.ossie.corba.utils.Init(new String[0], null);

        port = new Out@name@Port(helper.getName() + "_out");
        port._this_object(orb);

        stub = _createStub();

        org.omg.CORBA.Object objref = stub._this_object(orb);
        port.connectPort(objref, "connection_1");
    }

    @After
    public void tearDown()
    {
        _disconnectPorts();
    }

    protected void _disconnectPorts()
    {
        for (ExtendedCF.UsesConnection connection : port.connections()) {
            try {
                port.disconnectPort(connection.connectionId);
            } catch (Throwable exc) {
                // Ignore CORBA exceptions
            }
        }
    }

    protected void _releaseServants()
    {
        try {
            org.omg.PortableServer.POA poa = stub._default_POA();
            byte[] object_id = poa.servant_to_id(stub);
            poa.deactivate_object(object_id);
        } catch (Throwable exc) {
            // Ignore CORBA exceptions
        }
    }

    protected stubs.In@name@PortStub _createStub()
    {
        return new stubs.In@name@PortStub();
    }

    @Test
    public void testConnections() throws org.omg.CORBA.UserException
    {
        // Should start with one connection, to the in port stub
        ExtendedCF.UsesConnection[] connections = port.connections();
        Assert.assertNotNull(connections);
        Assert.assertEquals(1, connections.length);
        Assert.assertEquals("connection_1", connections[0].connectionId);
        org.omg.CORBA.Object objref = stub._this_object(org.ossie.corba.utils.Orb());
        Assert.assertTrue(connections[0].port._is_equivalent(objref));
        Assert.assertEquals("Port state should be active", BULKIO.PortUsageType.ACTIVE, port.state());

        // Should throw an invalid port on a nil
        try {
            port.connectPort(null, "connection_nil");
            Assert.fail("No exception thrown on connection to nil object");
        } catch (CF.PortPackage.InvalidPort exc) {
            // Test passed
        }

        // Normal connection
        stubs.In@name@PortStub stub2 = _createStub();
        objref = stub2._this_object(org.ossie.corba.utils.Orb());
        port.connectPort(objref, "connection_2");
        connections = port.connections();
        Assert.assertNotNull(connections);
        Assert.assertEquals(2, connections.length);
        for (ExtendedCF.UsesConnection connection : connections) {
            if (connection.connectionId.equals("connection_2")) {
                Assert.assertTrue(connection.port._is_equivalent(objref));
            } else if (!connection.connectionId.equals("connection_1")) {
                Assert.fail("Invalid connectionId in connections(): '" + connection.connectionId + "'");
            }
        }

        // Cannot reuse connection ID
        try {
            port.connectPort(objref, "connection_2");
            Assert.fail("No exception thrown on duplicate connectionId");
        } catch (CF.PortPackage.OccupiedPort exc) {
            // Test passed
        }

        // Disconnect second connection
        port.disconnectPort("connection_2");
        connections = port.connections();
        Assert.assertNotNull(connections);
        Assert.assertEquals(1, connections.length);
        Assert.assertEquals("connection_1", connections[0].connectionId);

        // Bad connection ID on disconnect
        try {
            port.disconnectPort("connection_bad");
            Assert.fail("No exception thrown on invalid connectionId");
        } catch (CF.PortPackage.InvalidPort exc) {
            // Test passed
        }

        // Disconnect the default stub; port should go to idle
        port.disconnectPort("connection_1");
        connections = port.connections();
        Assert.assertNotNull(connections);
        Assert.assertEquals(0, connections.length);
        Assert.assertEquals("Port state should be idle", BULKIO.PortUsageType.IDLE, port.state());
    }

    @Test
    public void testStatistics()
    {
        BULKIO.UsesPortStatistics[] uses_stats = port.statistics();
        Assert.assertNotNull(uses_stats);
        Assert.assertEquals(1, uses_stats.length);
        Assert.assertEquals("connection_1", uses_stats[0].connectionId);

        BULKIO.StreamSRI sri = bulkio.sri.utils.create("port_stats");
        port.pushSRI(sri);

        helper.pushTestPacket(port, 1024, bulkio.time.utils.now(), false, sri.streamID);

        uses_stats = port.statistics();
        Assert.assertNotNull(uses_stats);
        Assert.assertEquals(1, uses_stats.length);
        BULKIO.PortStatistics stats = uses_stats[0].statistics;

        Assert.assertTrue(stats.elementsPerSecond > 0.0);
        int bits_per_element = Math.round(stats.bitsPerSecond / stats.elementsPerSecond);
        Assert.assertEquals(@name@TestHelper.BITS_PER_ELEMENT, bits_per_element);
    }
}
